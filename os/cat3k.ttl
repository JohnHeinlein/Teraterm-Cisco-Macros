; .======================================
; | Catalyst 3000 Series Wiping Macro
; |======================================
; | Some unique shenanigans, since ROMMON is weirdd
; '--------------------------------------

; .======================================
; | Wait for stdout to finish spamming
; '--------------------------------------

include 'util/stdout.ttl'

sendln 'en'

; .======================================
; | Parse & wipe flash
; '--------------------------------------
include 'util\flash_parse.ttl'
include 'util\flash_wipe.ttl'
include 'util\dir_flash.ttl'

; .======================================
; | Wipe NVRAM & reboot
; '--------------------------------------
newstat = #10'Clearing NVRAM...'
include 'util\stat.ttl'
;strconcat statstr #10'Clearing NVRAM...'
;statusbox statstr hostname

sendln 'write erase'
wait '[confirm]'
send #13

; .======================================
; | Reset config register from within IOS
; '--------------------------------------
;sendln 'configure terminal'
;waitln 'Switch(config)#'
;sendln 'config-register 0x2142'
;waitln 'Switch(config)#'
;sendln 'exit'

setsync 1
wait 'Switch#'
sendln 'reload'
waitregex '[yes/no]' '[confirm]'
if result = 1 then
	sendln 'no'
	sendln 'reload'
	wait '[confirm]'
endif
send #13
setsync 0

wait 'Interrupt the system within 5 seconds'
sendbreak
wait 'switch:'
	sendln 'set SWITCH_IGNORE_STARTUP_CFG 0'
	sendln 'set ENABLE_BREAK no'
endif

exit