; .======================================
; | Driver for all macro files
; |--------------------------------------
; | Determines the type of device being run, and
; |	calls appropriate subroutines
; '--------------------------------------

; Useful string aliases
dir_flash = 'util\dir_flash.ttl'
stat = 'util\stat.ttl'
db = 'util\debug.ttl'
db2 = 'util\debug2.ttl'
CRITICAL_FILES = '((PTW)|(SE[0-9])|(E(X?)[0-9])|(\.bin)|(\.conf)|(\.lic)|(\.pkg)|(\.pack)$)' ; Regular expression matching files we DON'T want to delete

; .======================================
; | Debugging
; |--------------------------------------
; | Running files directly messes up the relative paths.
; | Set 'totest' to path & name of file to test
; | debug = 1 -> Some extra logging
; | debug = 2 -> Log entry & exit of subroutines
; '--------------------------------------
stat_mode = 0 ; Set to enable status box messages at all
debug_mode = 0
totest = '' ; If none is specified, 'debug_mode = 1' just enables debug messages.
if debug_mode > 0 call debug

; .======================================
; | init
; '--------------------------------------
if stat_mode then
	statstr = ''
	newstat = ''
	gethostname hostname
	statusbox statstr hostname

	newstat = hostname
	strconcat newstat ' init'
	include stat
endif

; .======================================
; | Model selector
; |--------------------------------------
; | Once in ROMMON, we use some heuristic to determine the model of switch.
; | Not trivial, since different switches can have dramatically different 
; | bootloaders and rom monitors
; '--------------------------------------
setsync 1
sendln 'version'
recvln ; First captures the command i just sent? lol
recvln
setsync 0
if result = 1 then
	; Catalyst 2960 Series Switches
	strmatch inputstr '^C2960.?\s'	
	if result = 1 then
		newstat = '**C2960 ROMMON Detected**'
		include stat
		include 'rommon\2960.ttl'
		include 'os\switch.ttl'
		goto finish
	endif
	
	; Catalyst 3000 Series Switches
	strmatch inputstr '^CAT3K_CAA\s'
	if result = 1 then
		newstat = '**C3K ROMMON Detected**'
		include stat
		include 'rommon\cat3k.ttl'
		include 'os\cat3k.ttl'
		goto finish
	endif
	
	; Catalyst 3750 series switches
	strmatch inputstr '^C3750[A-Z]?\s'
	if result = 1 then
		newstat = '**C3750 ROMMON Detected**'
		include stat
		include 'rommon\2960.ttl'
		include 'os\switch.ttl'
		goto finish
	endif
	
	; Detect any 'rommon' prompt, as opposed to a 'switch' prompt, to assume we're in a router.
	timeout = 1
	waitregex 'rommon [0-9]+'
	if result > 0 then
		newstat = #10'Router assumed'
		include stat
		include 'rommon\isr.ttl'
		include 'os\router.ttl'
		goto finish
	endif
	
	if result = 0 goto no_match
endif

:finish
	if debug_mode = 0 then
		clearscreen 1
		include dir_flash
	endif

	gethostname hostname
	endMessage = #10#10
	strconcat endMessage hostname
	strconcat endMessage ' finished!'
	strconcat statstr endMessage
	messagebox statstr 'Done!'
end

:no_match
	messagebox 'No supported device detected, exiting' 'Err'
end

:debug
	gethostname hostname
	strconcat hostname ' [DEBUG]'
	newstat = 'init'
	include db
	
	strlen totest
	if result > 0 then
		include totest
		end
	endif
return
